!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";var a=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};var s=function(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t};var n=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n};var e=function(t){if(Array.isArray(t))return n(t)};var r=function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)};var o=function(t,e){if(t){if("string"==typeof t)return n(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(t,e):void 0}};var i=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")};var c=function(t){return e(t)||r(t)||o(t)||i()},t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var u,d=(function(t){var e=function(a){var f,t=Object.prototype,l=t.hasOwnProperty,e="function"==typeof Symbol?Symbol:{},o=e.iterator||"@@iterator",r=e.asyncIterator||"@@asyncIterator",n=e.toStringTag||"@@toStringTag";function s(t,e,r,n){var i,a,s,c,o=e&&e.prototype instanceof m?e:m,u=Object.create(o.prototype),l=new S(n||[]);return u._invoke=(i=t,a=r,s=l,c=d,function(t,e){if(c===v)throw new Error("Generator is already running");if(c===y){if("throw"===t)throw e;return T()}for(s.method=t,s.arg=e;;){var r=s.delegate;if(r){var n=function t(e,r){var n=e.iterator[r.method];if(n===f){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=f,t(e,r),"throw"===r.method))return g;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return g}var o=h(n,e.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,g;var i=o.arg;return i?i.done?(r[e.resultName]=i.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=f),r.delegate=null,g):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}(r,s);if(n){if(n===g)continue;return n}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if(c===d)throw c=y,s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);c=v;var o=h(i,a,s);if("normal"===o.type){if(c=s.done?y:p,o.arg===g)continue;return{value:o.arg,done:s.done}}"throw"===o.type&&(c=y,s.method="throw",s.arg=o.arg)}}),u}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}a.wrap=s;var d="suspendedStart",p="suspendedYield",v="executing",y="completed",g={};function m(){}function i(){}function c(){}var u={};u[o]=function(){return this};var b=Object.getPrototypeOf,w=b&&b(b(k([])));w&&w!==t&&l.call(w,o)&&(u=w);var x=c.prototype=m.prototype=Object.create(u);function L(t){["next","throw","return"].forEach(function(e){t[e]=function(t){return this._invoke(e,t)}})}function O(c,u){var e;this._invoke=function(r,n){function t(){return new u(function(t,e){!function e(t,r,n,o){var i=h(c[t],c,r);if("throw"!==i.type){var a=i.arg,s=a.value;return s&&"object"==typeof s&&l.call(s,"__await")?u.resolve(s.__await).then(function(t){e("next",t,n,o)},function(t){e("throw",t,n,o)}):u.resolve(s).then(function(t){a.value=t,n(a)},function(t){return e("throw",t,n,o)})}o(i.arg)}(r,n,t,e)})}return e=e?e.then(t,t):t()}}function E(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function j(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function S(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(E,this),this.reset(!0)}function k(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,n=function t(){for(;++r<e.length;)if(l.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=f,t.done=!0,t};return n.next=n}}return{next:T}}function T(){return{value:f,done:!0}}return(i.prototype=x.constructor=c).constructor=i,c[n]=i.displayName="GeneratorFunction",a.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===i||"GeneratorFunction"===(e.displayName||e.name))},a.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,n in t||(t[n]="GeneratorFunction")),t.prototype=Object.create(x),t},a.awrap=function(t){return{__await:t}},L(O.prototype),O.prototype[r]=function(){return this},a.AsyncIterator=O,a.async=function(t,e,r,n,o){void 0===o&&(o=Promise);var i=new O(s(t,e,r,n),o);return a.isGeneratorFunction(e)?i:i.next().then(function(t){return t.done?t.value:i.next()})},L(x),x[n]="Generator",x[o]=function(){return this},x.toString=function(){return"[object Generator]"},a.keys=function(r){var n=[];for(var t in r)n.push(t);return n.reverse(),function t(){for(;n.length;){var e=n.pop();if(e in r)return t.value=e,t.done=!1,t}return t.done=!0,t}},a.values=k,S.prototype={constructor:S,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=f,this.done=!1,this.delegate=null,this.method="next",this.arg=f,this.tryEntries.forEach(j),!t)for(var e in this)"t"===e.charAt(0)&&l.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=f)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var n=this;function t(t,e){return i.type="throw",i.arg=r,n.next=t,e&&(n.method="next",n.arg=f),!!e}for(var e=this.tryEntries.length-1;0<=e;--e){var o=this.tryEntries[e],i=o.completion;if("root"===o.tryLoc)return t("end");if(o.tryLoc<=this.prev){var a=l.call(o,"catchLoc"),s=l.call(o,"finallyLoc");if(a&&s){if(this.prev<o.catchLoc)return t(o.catchLoc,!0);if(this.prev<o.finallyLoc)return t(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return t(o.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return t(o.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;0<=r;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&l.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=t,i.arg=e,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),g},finish:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),j(r),g}},catch:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n,o=r.completion;return"throw"===o.type&&(n=o.arg,j(r)),n}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:k(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=f),g}},a}(t.exports);try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}}(u={exports:{}}),u.exports);function l(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}var f=function(s){return function(){var t=this,a=arguments;return new Promise(function(e,r){var n=s.apply(t,a);function o(t){l(n,e,r,o,i,"next",t)}function i(t){l(n,e,r,o,i,"throw",t)}o(void 0)})}},h=1/0,p="[object Symbol]",v=/&(?:amp|lt|gt|quot|#39|#96);/g,y=RegExp(v.source),g="object"==typeof t&&t&&t.Object===Object&&t,m="object"==typeof self&&self&&self.Object===Object&&self,b=g||m||Function("return this")();var w,x=(w={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#96;":"`"},function(t){return null==w?void 0:w[t]}),L=Object.prototype.toString,O=b.Symbol,E=O?O.prototype:void 0,j=E?E.toString:void 0;function S(t){if("string"==typeof t)return t;if("symbol"==typeof(e=t)||function(t){return t&&"object"==typeof t}(e)&&L.call(e)==p)return j?j.call(t):"";var e,r=t+"";return"0"==r&&1/t==-h?"-0":r}var k=function(t){var e;return(t=null==(e=t)?"":S(e))&&y.test(t)?t.replace(v,x):t},T=/^###@([\S]+)([\s\S]*?)###/gm,_=/^#@([\S]+)(.*)$/gm,P=/\[\[(.*?)\]\]/gm,A="__TOKEN_ESCAPED_BACKSLASH_OCTO__",M=/###[\s\S]*?###/gm,H=/^#.*$/gm;function C(e,t){var r,n=Object.keys(e);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(e),t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)),n}function D(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?C(Object(r),!0).forEach(function(t){s(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):C(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function q(r){var t=r.source,e=function(t){var n=[];for(t=t.replace("\\#","__TOKEN_ESCAPED_BACKSLASH_OCTO__");t.match(T);)t=t.replace(T,function(t,e,r){return n.push({name:"@".concat(e),content:r.trim()}),""});for(;t.match(_);)t=t.replace(_,function(t,e,r){return n.push({name:"@".concat(e),content:r.trim()}),""});return n}(t),n=t.replace("\\#",A).replace(M,"").replace(H,"").replace(A,"#").trim();r&&(r.links=[]);var o,i=function(t){for(var s=[],e=t;t.match(P);)t=t.replace(P,function(t,e){var r=e,n=e,o=e.indexOf("|"),i=e.indexOf("->"),a=e.indexOf("<-");switch(!0){case 0<=o:r=e.substr(0,o),n=e.substr(o+1);break;case 0<=i:r=e.substr(0,i),n=e.substr(i+2);break;case 0<=a:r=e.substr(a+2),n=e.substr(0,a)}return s.push({display:r,target:n}),""});return{links:s,updated:t,original:e}}(n),n=i.updated;return r&&(r.links=i.links),e.forEach(function(e){r.story.directives[e.name]&&r.story.directives[e.name].forEach(function(t){n=t(e.content,n,r,r.story)})}),r.getSpeaker()?(!r||(o=r.prefixTag("prompt")).length&&r.story.prompt(o[0]),r.hasTag("oneline")?{directives:e,text:[n]}:{directives:e,text:(n=n.trim()).split(/[\r\n]+/g)}):{directives:e,text:[]}}function N(t,e,r,n,o){var i=this;a(this,N),s(this,"id",null),s(this,"name",null),s(this,"tags",null),s(this,"tagDict",{}),s(this,"source",null),s(this,"links",[]),s(this,"getSpeaker",function(){var t=i.tags.find(function(t){return 0===t.indexOf("speaker-")})||"";return t?t.replace(/^speaker-/,""):null}),s(this,"prefixTag",function(e,r){return i.tags.filter(function(t){return 0===t.indexOf("".concat(e,"-"))}).map(function(t){return t.replace("".concat(e,"-"),"")}).reduce(function(t,e){return r?D(D({},t),{},s({},e,1)):[].concat(c(t),[e])},r?{}:[])}),s(this,"hasTag",function(t){return i.tagDict[t]}),s(this,"render",function(){return q(i)}),this.id=t,this.name=e,this.tags=r,this.source=k(n),this.story=o,this.tags.forEach(function(t){return i.tagDict[t]=1})}s(N,"render",function(t){return q(new N(null,null,null,t,(e=window||null)&&e.story?e.story:{state:{}}));var e});var F=1/0,G="[object Symbol]",I=/[&<>"'`]/g,B=RegExp(I.source),K="object"==typeof t&&t&&t.Object===Object&&t,R="object"==typeof self&&self&&self.Object===Object&&self,$=K||R||Function("return this")();var U,Y=(U={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},function(t){return null==U?void 0:U[t]}),z=Object.prototype.toString,J=$.Symbol,Q=J?J.prototype:void 0,V=Q?Q.toString:void 0;function W(t){if("string"==typeof t)return t;if("symbol"==typeof(e=t)||function(t){return t&&"object"==typeof t}(e)&&z.call(e)==G)return V?V.call(t):"";var e,r=t+"";return"0"==r&&1/t==-F?"-0":r}function X(t,e){return t.querySelector(e)}function Z(t,e){return c(t.querySelectorAll(e))||[]}function tt(t,e){var h=this;a(this,tt),s(this,"version",2),s(this,"document",null),s(this,"story",null),s(this,"name",""),s(this,"startsAt",0),s(this,"current",0),s(this,"history",[]),s(this,"passages",{}),s(this,"showPrompt",!1),s(this,"errorMessage","⚠ %s"),s(this,"directives",{}),s(this,"elements",{}),s(this,"userScripts",[]),s(this,"userStyles",[]),s(this,"start",function(){h.userStyles.forEach(function(t){var e=h.document.createElement("style");e.innerHTML=t,h.document.body.appendChild(e)}),h.userScripts.forEach(function(t){globalEval(t)}),h.document.body.addEventListener("click",function(t){t.target.matches("#user-response-panel a[data-passage]")&&h.advance(h.findPassage(t.target.getAttribute("data-passage")),t.target.innerHTML)}),h.document.body.addEventListener("click",function(t){var e;t.target.matches("#user-response-panel button[data-passage]")&&(e=X(h.document,"#user-response-panel input").value,h.showPrompt=!1,h.advance(h.findPassage(t.target.getAttribute("data-passage")),e))}),h.advance(h.findPassage(h.startsAt))}),s(this,"findPassage",function(e){if(e="".concat(e).trim(),t=e,at.test(t))return h.passages[e];var t,r=Z(h.story,"tw-passagedata").filter(function(t){return k(t.getAttribute("name")).trim()===e})[0];return r?h.passages[r.getAttribute("pid")]:null}),s(this,"advance",function(){var e=f(d.mark(function t(e){var r,n,o,i=arguments;return d.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=1<i.length&&void 0!==i[1]?i[1]:null,h.history.push(e.id),n=h.current,o=h.elements.active.innerHTML,h.elements.active.innerHTML="",h.elements.history.innerHTML+=o,r&&h.renderUserMessage(n,r,function(t){return h.elements.history.innerHTML+=t}),t.next=9,h.renderPassage(e,function(t){return h.elements.active.innerHTML+=t});case 9:if(e.hasTag("wait")||1!==e.links.length){t.next=12;break}return h.advance(h.findPassage(e.links[0].target)),t.abrupt("return");case 12:h.renderChoices(e);case 13:case"end":return t.stop()}},t)}));return function(t){return e.apply(this,arguments)}}()),s(this,"renderUserMessage",function(){var n=f(d.mark(function t(o,i,a){return d.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a((0,r=(e={id:o,text:i}).id,n=e.text,'\n  <div class="chat-passage-reset">\n    <div class="chat-passage-wrapper" data-speaker="you">\n      <div class="chat-passage" data-speaker="you" data-upassage="'.concat(r,'">\n        ').concat(n,"\n      </div>\n    </div>\n  </div>\n")));case 2:return h.scrollToBottom(),t.abrupt("return",Promise.resolve());case 4:case"end":return t.stop()}var e,r,n},t)}));return function(t,e,r){return n.apply(this,arguments)}}()),s(this,"renderPassage",function(){var r=f(d.mark(function t(a,s){var c,u,l,f;return d.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return c=a.getSpeaker(),u=a.render(),console.log(u.directives),t.next=5,s((i=u.directives,'\n  <div class="directives">\n    '.concat(i.map(function(t){var e=t.name,r=t.content;return'<div class="directive" name="'.concat(e,'">').concat(r.trim(),"</div>")}).join(""),"\n  </div>\n")));case 5:l=u.text.shift(),h.showTyping();case 7:if(l)return e={speaker:c,tags:a.tags,text:l},n=void 0,r=e.speaker,n=e.tags,o=e.text,f='\n  <div class="chat-passage-reset">\n    <div data-speaker="'.concat(r,'" class="chat-passage-wrapper ').concat(n.join(" "),'">\n      <div data-speaker="').concat(r,'" class="chat-passage">\n        ').concat(o,"\n      </div>\n    </div>\n  </div>\n"),t.next=11,st(h.calculateDelay(l));t.next=16;break;case 11:return t.next=13,s(f);case 13:l=u.text.shift(),t.next=7;break;case 16:return h.hideTyping(),h.scrollToBottom(),t.abrupt("return",Promise.resolve());case 19:case"end":return t.stop()}var e,r,n,o,i},t)}));return function(t,e){return r.apply(this,arguments)}}()),s(this,"calculateDelay",function(t){return 20*t.length*.3}),s(this,"showTyping",function(){X(h.document,it).style.visibility="visible"}),s(this,"hideTyping",function(){X(h.document,it).style.visibility="hidden"}),s(this,"scrollToBottom",function(){var t=X(h.document,nt);document.scrollingElement.scrollTop=t.offsetHeight}),s(this,"removeChoices",function(){X(h.document,ot).innerHTML=""}),s(this,"renderChoices",function(t){h.removeChoices();var e=X(h.document,ot);t.links.forEach(function(t){e.innerHTML+='<a href="javascript:void(0)" class="user-response" data-passage="'.concat(rt(t.target),'">').concat(t.display,"</a>")})}),s(this,"directive",function(t,e){h.directives[t]||(h.directives[t]=[]),h.directives[t].push(e)}),this.window=t,this.document=e?document.implementation.createHTMLDocument("Botscripten Injected Content"):document,this.story=X(this.document,"tw-storydata"),this.elements={active:X(this.document,"#active-passage"),history:X(this.document,nt)},this.name=this.story.getAttribute("name")||"",this.startsAt=this.story.getAttribute("startnode")||0,Z(this.story,"tw-passagedata").forEach(function(t){var e=parseInt(t.getAttribute("pid")),r=t.getAttribute("name"),n=(t.getAttribute("tags")||"").split(/\s+/g),o=t.innerHTML||"";h.passages[e]=new N(e,r,n,o,h)}),X(this.document,"title").innerHTML=this.name,this.userScripts=(Z(this.document,'*[type="text/twine-javascript"]')||[]).map(function(t){return t.innerHTML}),this.userStyles=(Z(this.document,'*[type="text/twine-css"]')||[]).map(function(t){return t.innerHTML})}var et,rt=function(t){var e;return(t=null==(e=t)?"":W(e))&&B.test(t)?t.replace(I,Y):t},nt="#history",ot="#user-response-panel",it="#animation-container",at=/^[\d]+$/,st=function(){var t=f(d.mark(function t(){var e,r=arguments;return d.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=0<r.length&&void 0!==r[0]?r[0]:0,t.abrupt("return",new Promise(function(t){return setTimeout(t,e)}));case 2:case"end":return t.stop()}},t)}));return function(){return t.apply(this,arguments)}}();void 0!==(et=window||void 0)&&(et.document.addEventListener("DOMContentLoaded",function(t){et.globalEval=eval,et.story=new tt(et),et.story.start(),et.document.querySelector("#show_directives").checked&&et.document.body.classList.add("show-directives"),et.document.querySelector("#proofing").checked?et.document.body.classList.add("proof"):et.document.body.classList.add("run")}),et.document.querySelector("#show_directives").addEventListener("change",function(t){t.target.checked?et.document.body.classList.add("show-directives"):et.document.body.classList.remove("show-directives")}),et.document.querySelector("#proofing").addEventListener("change",function(t){t.target.checked?(et.document.body.classList.add("proof"),et.document.body.classList.remove("run")):(et.document.body.classList.add("run"),et.document.body.classList.remove("proof"))}),document.querySelector("tw-passagedata[pid='"+document.querySelector("tw-storydata").getAttribute("startnode")+"']").classList.add("start"))});
